<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
    <link rel="stylesheet" href="styles/dashboard.css" />
  </head>
  <body>
    <header>
      <h1>Fitzy <span>Fitness</span></h1>
      <nav>
        <a href="home.html" class="highlight-btn">Home</a>
        <a href="index.html" class="highlight-btn">Log Out</a>
      </nav>
    </header>

    <div class="main-card">
      <!-- Column 1 -->
      <div class="column profile">
        <h2>Loading...</h2>
        <img src="photos/1308025.jpg" alt="Profile Photo" />
        <div class="profile-buttons">
          <button class="btn" onclick="openUpdateModal()">
            Update Profile
          </button>
          <button class="btn">Update Photo</button>
        </div>
      </div>

      <!-- Column 2 -->
      <div class="column">
        <div class="inner-card">
          <h3>ðŸ“Œ Personal Details</h3>
          <ul>
            <li>Name: Loading...</li>
            <li>Age: Loading...</li>
            <li>DOB: Loading...</li>
            <li>Gender: Loading...</li>
          </ul>
        </div>
        <div class="inner-card">
          <h3>ðŸ“ž Contact Information</h3>
          <ul>
            <li>Email: Loading...</li>
            <li>Phone: Loading...</li>
            <li>Address: Loading...</li>
          </ul>
        </div>
      </div>

      <!-- Column 3 -->
      <div class="column">
        <div class="inner-card">
          <h3>ðŸŽ¯ Goals & Motivation</h3>
          <p>Loading...</p>
        </div>

        <div class="inner-card bmi-calculator">
          <h3>ðŸ“Š BMI Calculator</h3>
          <label for="height">Height (cm):</label>
          <input type="number" id="height" placeholder="Enter height in cm" />
          <label for="weight">Weight (kg):</label>
          <input type="number" id="weight" placeholder="Enter weight in kg" />
          <button onclick="calculateBMI()">Calculate BMI</button>
          <p id="bmiResult"></p>
        </div>
      </div>
    </div>

    <!-- Update Profile Modal -->
    <div id="updateModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeUpdateModal()">&times;</span>
        <h3 class="modal-title">Update Profile</h3>
        <form id="updateProfileForm">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="full_name" required />
          </div>

          <div class="form-group">
            <label>Age</label>
            <input type="number" name="age" />
          </div>

          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" name="date_of_birth" />
          </div>

          <div class="form-group">
            <label>Gender</label>
            <input type="text" name="gender" />
          </div>

          <div class="form-group">
            <label>Phone Number</label>
            <input type="text" name="phone_number" />
          </div>

          <div class="form-group">
            <label>Address</label>
            <input type="text" name="home_address" />
          </div>

          <div class="form-group">
            <label>Main Goal</label>
            <textarea name="main_goal"></textarea>
          </div>

          <button type="submit" class="btn modal-save-btn">
            ðŸ’¾ Save Changes
          </button>
        </form>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 Fitzy Fitness. All rights reserved.</p>
    </footer>

    <script>
      async function loadUserData() {
        try {
          const response = await fetch("dashboard.php", {
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error("Failed to load user data");
          }
          const user = await response.json();

          if (user.error) {
            alert(user.error);
            return;
          }

          // Update profile column
          document.querySelector(".profile h2").textContent = user.full_name;

          // Update Personal Details
          const personalDetails = `
            <li>Name: ${user.full_name}</li>
            <li>Age: ${user.age}</li>
            <li>DOB: ${user.date_of_birth}</li>
            <li>Gender: ${user.gender}</li>
          `;
          document.querySelector(
            ".main-card .column:nth-child(2) .inner-card:nth-child(1) ul"
          ).innerHTML = personalDetails;

          // Update Contact Information
          const contactInfo = `
            <li>Email: ${user.email}</li>
            <li>Phone: ${user.phone_number ?? "N/A"}</li>
            <li>Address: ${user.home_address ?? "N/A"}</li>
          `;
          document.querySelector(
            ".main-card .column:nth-child(2) .inner-card:nth-child(2) ul"
          ).innerHTML = contactInfo;

          // Update Goals & Motivation
          document.querySelector(
            ".main-card .column:nth-child(3) .inner-card:nth-child(1) p"
          ).textContent = user.main_goal ?? "Not specified";
        } catch (error) {
          console.error(error);
          alert("Error loading user data");
        }
      }

      window.onload = loadUserData;

      function calculateBMI() {
        const height = parseFloat(document.getElementById("height").value);
        const weight = parseFloat(document.getElementById("weight").value);
        const result = document.getElementById("bmiResult");

        if (!height || !weight || height <= 0 || weight <= 0) {
          result.textContent = "Please enter valid height and weight.";
          return;
        }

        const heightM = height / 100;
        const bmi = (weight / (heightM * heightM)).toFixed(1);

        let status = "";
        if (bmi < 18.5) status = "Underweight";
        else if (bmi < 24.9) status = "Normal weight";
        else if (bmi < 29.9) status = "Overweight";
        else status = "Obese";

        result.textContent = `Your BMI is ${bmi} (${status})`;
      }

      function openUpdateModal() {
        document.getElementById("updateModal").style.display = "block";
      }
      function closeUpdateModal() {
        document.getElementById("updateModal").style.display = "none";
      }

      // Close modal if clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("updateModal")) {
          closeUpdateModal();
        }
      };

      let userData = {};

      async function loadUserData() {
        try {
          const response = await fetch("dashboard.php", {
            credentials: "include",
          });
          const user = await response.json();

          if (user.error) {
            alert(user.error);
            return;
          }

          userData = user; // store for later use

          document.querySelector(".profile h2").textContent = user.full_name;

          document.querySelector(
            ".main-card .column:nth-child(2) .inner-card:nth-child(1) ul"
          ).innerHTML = `
      <li>Name: ${user.full_name}</li>
      <li>Age: ${user.age}</li>
      <li>DOB: ${user.date_of_birth}</li>
      <li>Gender: ${user.gender}</li>
    `;

          document.querySelector(
            ".main-card .column:nth-child(2) .inner-card:nth-child(2) ul"
          ).innerHTML = `
      <li>Email: ${user.email}</li>
      <li>Phone: ${user.phone_number ?? "N/A"}</li>
      <li>Address: ${user.home_address ?? "N/A"}</li>
    `;

          document.querySelector(
            ".main-card .column:nth-child(3) .inner-card:nth-child(1) p"
          ).textContent = user.main_goal ?? "Not specified";
        } catch (error) {
          console.error(error);
          alert("Error loading user data");
        }
      }

      function openUpdateModal() {
        // Fill form with existing details
        const form = document.getElementById("updateProfileForm");
        form.full_name.value = userData.full_name || "";
        form.age.value = userData.age || "";
        form.date_of_birth.value = userData.date_of_birth || "";
        form.gender.value = userData.gender || "";
        form.phone_number.value = userData.phone_number || "";
        form.home_address.value = userData.home_address || "";
        form.main_goal.value = userData.main_goal || "";

        document.getElementById("updateModal").style.display = "block";
      }

      function closeUpdateModal() {
        document.getElementById("updateModal").style.display = "none";
      }

      document
        .getElementById("updateProfileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            full_name: this.full_name.value,
            age: this.age.value,
            date_of_birth: this.date_of_birth.value,
            gender: this.gender.value,
            phone_number: this.phone_number.value,
            home_address: this.home_address.value,
            main_goal: this.main_goal.value,
          };

          try {
            const response = await fetch("update_profile.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.success) {
              alert("Profile updated successfully!");
              closeUpdateModal();
              loadUserData(); // reload updated data
            } else {
              alert(result.error || "Update failed.");
            }
          } catch (error) {
            console.error(error);
            alert("An error occurred while updating the profile.");
          }
        });

      window.onload = loadUserData;
    </script>
  </body>
</html>
